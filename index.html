<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Tenant Manager â€“ Bronze</title>

  <!-- =================================
       HARD BLOCK RENDER (NO FLASH)
  ================================= -->
  <style>
    html {
      visibility: hidden;
    }
  </style>

  <!-- =================================
       AUTH GATE (RUNS BEFORE PAINT)
  ================================= -->
  <script type="module">
    import { supabase } from "./scripts/supabase.js";

    const { data: { session } } = await supabase.auth.getSession();

    if (!session) {
      window.location.replace("/login.html");
    } else {
      document.documentElement.style.visibility = "visible";
    }
  </script>
</head>

<body>

  <h1>My Tenant Manager</h1>
  <p>Bronze Tier</p>

  <hr>

  <!-- =================================
       LANDLORD PROFILE (READ-ONLY)
  ================================= -->
  <h2>Landlord Profile</h2>

  <p>
    <strong>Email:</strong>
    <span id="profileEmail">N/A</span>
  </p>

  <p>
    <strong>Country:</strong>
    <span id="profileCountry">N/A</span>
  </p>

  <p>
    <strong>Currency:</strong>
    <span id="profileCurrency">N/A</span>
  </p>

  <p>
    <strong>Full Name:</strong>
    <span id="profileFullName">N/A</span>
  </p>

  <hr>

  <!-- =================================
       LANDLORD PROFILE (EDITABLE)
  ================================= -->
  <h3>Edit Profile</h3>

  <label>Full Name</label><br>
  <input id="fullNameInput" type="text"><br><br>

  <button id="saveProfileBtn">Save Profile</button>
  <p id="profileMessage">N/A</p>

  <hr>

  <!-- =================================
       SUPABASE TEST
  ================================= -->
  <button id="testBtn">Test Supabase Connection</button>
  <p id="result">N/A</p>

  <hr>

  <!-- =================================
       LOGOUT
  ================================= -->
  <button id="logoutBtn">Logout</button>

  <!-- =================================
       PAGE LOGIC
  ================================= -->
  <script type="module">
    import { supabase } from "./scripts/supabase.js";
    import { logout } from "./scripts/session.js";

    /* -----------------------------
       LOAD LANDLORD PROFILE
    ----------------------------- */
    async function loadProfile() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;

      const { data, error } = await supabase
        .from("users_profile")
        .select("email, country, currency_code, currency_symbol, full_name")
        .eq("id", user.id)
        .single();

      if (error) {
        console.error("Profile load error:", error.message);
        return;
      }

      document.getElementById("profileEmail").textContent =
        data.email || "N/A";

      document.getElementById("profileCountry").textContent =
        data.country || "N/A";

      document.getElementById("profileCurrency").textContent =
        `${data.currency_symbol} (${data.currency_code})`;

      document.getElementById("profileFullName").textContent =
        data.full_name || "N/A";

      document.getElementById("fullNameInput").value =
        data.full_name || "";
    }

    /* -----------------------------
       UPDATE PROFILE (FULL NAME)
    ----------------------------- */
    async function updateProfile() {
      const message = document.getElementById("profileMessage");
      const fullName = document.getElementById("fullNameInput").value.trim();

      message.textContent = "Saving...";

      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        message.textContent = "Not authenticated.";
        return;
      }

      const { error } = await supabase
        .from("users_profile")
        .update({ full_name: fullName || "N/A" })
        .eq("id", user.id);

      if (error) {
        message.textContent = error.message;
        return;
      }

      message.textContent = "Profile updated successfully.";

      // ðŸ”‘ Refresh displayed data immediately
      await loadProfile();
    }

    /* -----------------------------
       SUPABASE CONNECTION TEST
    ----------------------------- */
    document.getElementById("testBtn").addEventListener("click", async () => {
      const { error } = await supabase.auth.getSession();
      document.getElementById("result").textContent =
        error ? "Error: " + error.message : "Supabase connected successfully.";
    });

    /* -----------------------------
       LOGOUT
    ----------------------------- */
    document.getElementById("logoutBtn").addEventListener("click", logout);

    /* -----------------------------
       INIT
    ----------------------------- */
    document
      .getElementById("saveProfileBtn")
      .addEventListener("click", updateProfile);

    loadProfile();
  </script>

</body>
</html>
